{% extends "base.html" %}

{% block title %}{{ _('Create Tests') }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <!-- My Tests Section -->
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div>
                        <h4>{{ _('My Tests') }}</h4>
                    </div>
                    <button type="button" class="btn btn-primary" id="createTestsBtn" disabled>
                        <i class="fas fa-plus me-1"></i>{{ _('Create Tests') }}
                    </button>
                </div>

                <div class="card-body" id="testsTableContainer">
                    {% if teacher_type == 'homeroom' %}
                    <!-- Subject Filter for Homeroom Teachers -->
                    <form id="filterForm" class="mb-3">
                        <div class="row justify-content-center">
                            <div class="col-md-3 mb-2">
                                <label for="filter_subject" class="form-label">{{ _('Subject') }}:</label>
                                <select class="form-select" id="filter_subject" name="filter_subject" onchange="filterTests()">
                                    <option value="">{{ _('All Subjects') }}</option>
                                    {% for subject in subjects %}
                                        <option value="{{ subject }}" 
                                                {% if last_test and last_test.subject == subject %}selected{% endif %}>
                                            {{ subject }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </form>
                    {% endif %}
                    <div class="text-center py-4" id="noSelectionMessage">
                        <p class="text-muted">{{ _('Please select a Class and Semester to view tests.') }}</p>
                    </div>
                    
                    <!-- Tests Table -->
                    <div class="table-responsive" id="testsTable" style="display: none;">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>{{ _('Test Name') }}</th>
                                    <th>{{ _('Test Date') }}</th>
                                    {% for competency in competencies %}
                                        <th>{{ competency }}</th>
                                    {% endfor %}
                                    <th>{{ _('Actions') }}</th>
                                </tr>
                            </thead>
                            <tbody id="testsTableBody">
                                {% for test in tests %}
                                <tr class="test-row" 
                                    data-semester="{{ test.semester }}"
                                    data-grade="{{ test.grade or '' }}"
                                    data-class="{{ test.class_name or '' }}"
                                    data-subject="{{ test.subject or '' }}"
                                    data-competency="{{ test.competency }}">
                                    <td>{{ test.test_name }}</td>
                                    <td>{{ test.test_date.strftime('%Y-%m-%d') }}</td>
                                    {% for competency in competencies %}
                                        <td class="competency-cell" data-competency="{{ competency }}">
                                            {% if test.competency == competency %}
                                                {{ test.test_weight }}%
                                            {% endif %}
                                        </td>
                                    {% endfor %}
                                    <td>
                                        <button class="btn btn-sm btn-primary" onclick="editTest({{ test.id }})">{{ _('Edit') }}</button>
                                    </td>
                                </tr>
                                {% endfor %}
                                
                                <!-- Totals Row -->
                                <tr class="table-info fw-bold" id="totalsRow">
                                    <td colspan="2">{{ _('Totals') }}</td>
                                    {% for competency in competencies %}
                                        <td class="total-cell" data-competency="{{ competency }}">0%</td>
                                    {% endfor %}
                                    <td></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Define Tests Form Section -->
            <div class="card mb-4" id="defineTestsCard" style="display: none;">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div>
                        <h4>{{ _('Define Tests') }}</h4>
                        <p class="mb-0">{{ _('Please input the following information to define a test:') }}</p>
                    </div>
                    <div>
                        <strong id="header_class_semester_info" class="text-muted"></strong>
                    </div>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('main.create_tests') }}">
                        <!-- Hidden inputs to store inherited values -->
                        <input type="hidden" id="class_name" name="class_name">
                        <input type="hidden" id="semester" name="semester">
                        <input type="hidden" id="grade" name="grade">

                        {% if teacher_type == 'specialist' %}
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="test_scope" class="form-label">{{ _('Test scope') }}:</label>
                                <select class="form-select" id="test_scope" name="test_scope" required>
                                    <option value="class_only">{{ _('Create test for this class only') }}</option>
                                    <option value="grade_all" selected>{{ _('Create test for all classes in the grade') }}</option>
                                </select>
                            </div>
                        </div>
                        {% endif %}

                        <div class="row">
                            <!-- Competency -->
                            <div class="col-md-4 mb-3">
                                <label for="competency" class="form-label">{{ _('Competency') }}:</label>
                                <select class="form-select" id="competency" name="competency" required>
                                    <option value="">{{ _('Select Competency') }}</option>
                                    {% for competency in competencies %}
                                        <option value="{{ competency }}">{{ competency }}</option>
                                    {% endfor %}
                                </select>
                            </div>

                            <!-- Test Name -->
                            <div class="col-md-4 mb-3">
                                <label for="test_name" class="form-label">{{ _('Test name') }}:</label>
                                <input type="text" class="form-control" id="test_name" name="test_name" required>
                            </div>

                            <!-- Max Points -->
                            <div class="col-md-4 mb-3">
                                <label for="max_points" class="form-label">{{ _('Max points') }}:</label>
                                <input type="number" class="form-control" id="max_points" name="max_points" min="1" required>
                            </div>

                            <!-- Test Date -->
                            <div class="col-md-4 mb-3">
                                <label for="test_date" class="form-label">{{ _('Test date') }}:</label>
                                <input type="date" class="form-control" id="test_date" name="test_date" required>
                            </div>

                            <!-- Test Weight -->
                            <div class="col-md-4 mb-3">
                                <label for="test_weight" class="form-label">{{ _('Test weight') }}:</label>
                                <input type="number" class="form-control" id="test_weight" name="test_weight" min="1" max="100" required>
                            </div>

                            {% if teacher_type == 'homeroom' %}
                            <!-- Subject (Homeroom only) -->
                            <div class="col-md-4 mb-3">
                                <label for="subject" class="form-label">{{ _('Subject') }}:</label>
                                <select class="form-select" id="subject" name="subject" required>
                                    <option value="">{{ _('Select Subject') }}</option>
                                    {% for subject in subjects %}
                                        <option value="{{ subject }}">{{ subject }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            {% endif %}
                        </div>

                        <div class="row">
                            <div class="col-12 d-flex justify-content-between">
                                <button type="submit" class="btn btn-primary" id="submitButton">{{ _('Save Test') }}</button>
                                <button type="button" class="btn btn-danger" id="deleteButton" style="display: none;" onclick="confirmDeleteTest()">{{ _('Delete Test') }}</button>
                            </div>
                        </div>
                        
                        <!-- Hidden field for edit mode -->
                        <input type="hidden" id="editTestId" name="test_id" value="">
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script type="application/json" id="createTestsContextJson">{{ {
    'classroomsByGrade': classrooms_by_grade,
    'teacherType': teacher_type,
    'competencies': competencies,
    'translations': {
        'hideForm': _('Hide Form'),
        'createTests': _('Create Tests')
    },
    'homeroomClassName': current_user.class_name or '',
    'homeroomGrade': current_user.grade or '',
    'lastTestGrade': (last_test.grade if last_test and last_test.grade else None),
    'lastTestClassName': (last_test.class_name if last_test and last_test.class_name else None)
}|tojson }}</script>

<script>
window.CREATE_TESTS_CONTEXT = JSON.parse(document.getElementById('createTestsContextJson').textContent);
</script>

<script src="{{ url_for('static', filename='create_tests.js', v=static_version) }}"></script>

{% endblock %}
