{% extends "base.html" %}

{% block title %}{{ _('Classroom') }} - {{ _('Grading App') }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h1 class="mb-4">{{ _('Classroom Seating Chart') }}</h1>
            
            <!-- No Class Selection Message -->
            <div class="row mb-4" id="no-class-message">
                <div class="col-12">
                    <div class="alert alert-info text-center">
                        <h5>{{ _('Please select a classroom to display a seating chart') }}</h5>
                        <p class="mb-0">{{ _('Use the Class filter in the header above to select a classroom.') }}</p>
                    </div>
                </div>
            </div>
            
            <!-- Action Buttons (hidden initially) -->
            <div class="row mb-4" id="action-buttons" style="display: none;">
                <div class="col-12 d-flex justify-content-center">
                    <button class="btn btn-success me-2" id="saveBtn" onclick="saveClassroomLayout()" disabled>
                        <i class="bi bi-save"></i> {{ _('Save Layout') }}
                    </button>
                    <button class="btn btn-warning" id="editBtn" onclick="editClassroomLayout()" style="display: none;">
                        <i class="bi bi-pencil"></i> {{ _('Edit Layout') }}
                    </button>
                </div>
            </div>

            <!-- Classroom Area -->
            <div class="row">
                <div class="col-12">
                    <div id="classroom-container" style="position: relative; min-height: 500px; border: 3px solid #333; background-color: #f8f9fa; border-radius: 10px; margin-bottom: 30px; display: none;">
                        <div class="classroom-header p-2 text-center bg-light border-bottom">
                            <h5 class="mb-0">{{ _('Classroom') }}</h5>
                        </div>
                        
                        <!-- Teacher's Desk (fixed position at bottom center) -->
                        <div id="teacher-desk" class="desk teacher-desk" style="position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); width: 120px; height: 60px; background-color: #dc3545; color: white; border: 2px solid #333; border-radius: 5px; display: flex; align-items: center; justify-content: center; font-weight: bold; z-index: 10;">
                            {{ _('Teacher') }}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Student Desks Pool -->
            <div class="row" id="student-desks-section" style="display: none;">
                <div class="col-12">
                    <h5>{{ _('Student Desks') }} <small class="text-muted">({{ _('Drag desks into the classroom above') }})</small></h5>
                    <div id="student-desks-pool" class="p-3 border rounded" style="min-height: 150px; background-color: #e9ecef;">
                        <!-- Student desks will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Instructions -->
            <div class="row mt-3" id="instructions" style="display: none;">
                <div class="col-12">
                    <div class="alert alert-info">
                        <h6>{{ _('Instructions:') }}</h6>
                        <ul class="mb-0">
                            <li>{{ _('Select a grade and class to begin') }}</li>
                            <li>{{ _('Drag student desks from the pool below into the classroom') }}</li>
                            <li>{{ _('Arrange desks anywhere inside the classroom rectangle') }}</li>
                            <li>{{ _('Click "Save Layout" to save the seating arrangement') }}</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.desk {
    cursor: move;
    user-select: none;
    transition: all 0.2s ease;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.desk:hover {
    transform: scale(1.05);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}

.student-desk {
    width: 80px;
    height: 50px;
    background-color: #007bff;
    color: white;
    border: 2px solid #333;
    border-radius: 5px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    font-weight: bold;
    margin: 5px;
    position: relative;
}

.student-desk.in-classroom {
    position: absolute;
}

.teacher-desk {
    background-color: #dc3545 !important;
}

.classroom-dropzone {
    position: relative;
}

.drag-over {
    background-color: #d4edda !important;
    border-color: #28a745 !important;
}

.frozen .desk {
    cursor: default !important;
}

.frozen .student-desk:hover {
    transform: none !important;
}
</style>

<script>
let teacherType = '';
let currentStudents = [];
let classroomLayout = {};
let isFrozen = false;

// Initialize page when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    loadTeacherType();
    
    // Wait a moment for base.html to initialize global filters, then check selection
    setTimeout(function() {
        checkGlobalClassSelection();
    }, 1000);
});

function loadTeacherType() {
    fetch('/api/get_teacher_type')
        .then(response => response.json())
        .then(data => {
            teacherType = data.teacher_type;
            // Remove the restriction - allow both specialist and homeroom teachers to use classroom page
            // if (teacherType !== 'specialist') {
            //     document.querySelector('.container-fluid').innerHTML = 
            //         '<div class="alert alert-warning">{{ _("Classroom seating charts are only available for specialist teachers.") }}</div>';
            // }
        })
        .catch(error => {
            alert('Error loading teacher type.');
        });
}

// This function is no longer needed - global filters are initialized by base.html

// Check global class filter selection and load classroom accordingly
function checkGlobalClassSelection() {
    const globalClassFilter = document.getElementById('global_class_filter');
    const selectedClass = globalClassFilter ? globalClassFilter.value : '';
    
    
    if (selectedClass && teacherType === 'specialist') {
        loadStudentsForClass(selectedClass);
    } else if (selectedClass && teacherType === 'homeroom') {
        loadStudentsForClass(selectedClass);
    } else {
        showNoClassMessage();
    }
}

// Callback function for when global filters change
function onGlobalFiltersChanged() {
    checkGlobalClassSelection();
}

function loadStudentsForClass(className) {
    
    if (!className) {
        showNoClassMessage();
        return;
    }
    
    
    // Find the classroom and get students
    fetch('/api/get_teacher_classrooms')
        .then(response => response.json())
        .then(data => {
            
            // Look for classroom by name (className already includes grade info like "5A (Grade 5)")
            let classroom = null;
            
            if (data.classrooms && Array.isArray(data.classrooms)) {
                // First try exact match
                classroom = data.classrooms.find(c => c.name === className);
                // If not found, try matching just the base name (before the grade part)
                if (!classroom) {
                    classroom = data.classrooms.find(c => c.name.startsWith(className + ' ('));
                }
            }
            
            if (classroom) {
                return fetch(`/api/get_classroom_students/${classroom.id}`);
            } else {
                throw new Error('Classroom not found');
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success && data.students) {
                currentStudents = data.students;
                
                showClassroom();
                createStudentDesks();
                
                // Load saved layout if it exists
                loadSavedLayoutForClass(className);
            }
        })
        .catch(error => {
            showNoClassMessage();
        });
}

function showClassroom() {
    document.getElementById('no-class-message').style.display = 'none';
    document.getElementById('action-buttons').style.display = 'block';
    document.getElementById('classroom-container').style.display = 'block';
    document.getElementById('student-desks-section').style.display = 'block';
    document.getElementById('instructions').style.display = 'block';
    document.getElementById('saveBtn').disabled = false;
}

function showNoClassMessage() {
    document.getElementById('no-class-message').style.display = 'block';
    document.getElementById('action-buttons').style.display = 'none';
    document.getElementById('classroom-container').style.display = 'none';
    document.getElementById('student-desks-section').style.display = 'none';
    document.getElementById('instructions').style.display = 'none';
}

function hideClassroom() {
    showNoClassMessage();
}

function createStudentDesks() {
    const pool = document.getElementById('student-desks-pool');
    pool.innerHTML = '';
    
    console.log('Creating desks for students:', currentStudents);
    
    currentStudents.forEach(student => {
        const desk = document.createElement('div');
        desk.className = 'desk student-desk';
        desk.textContent = student.firstName || student.first_name || student.name || 'Student';
        desk.dataset.studentId = student.id;
        desk.draggable = true;
        
        console.log('Created desk for student:', student.firstName || student.first_name || student.name, 'with text:', desk.textContent);
        
        // Add drag event listeners
        desk.addEventListener('dragstart', handleDragStart);
        desk.addEventListener('dragend', handleDragEnd);
        
        pool.appendChild(desk);
    });
    
    setupDropZone();
}

function setupDropZone() {
    const classroom = document.getElementById('classroom-container');
    
    classroom.addEventListener('dragover', handleDragOver);
    classroom.addEventListener('drop', handleDrop);
    classroom.addEventListener('dragenter', handleDragEnter);
    classroom.addEventListener('dragleave', handleDragLeave);
}

function handleDragStart(e) {
    if (isFrozen) {
        e.preventDefault();
        return;
    }
    
    e.dataTransfer.setData('text/plain', e.target.dataset.studentId);
    e.target.style.opacity = '0.5';
}

function handleDragEnd(e) {
    e.target.style.opacity = '1';
}

function handleDragOver(e) {
    if (isFrozen) return;
    e.preventDefault();
}

function handleDragEnter(e) {
    if (isFrozen) return;
    e.preventDefault();
    e.currentTarget.classList.add('drag-over');
}

function handleDragLeave(e) {
    if (isFrozen) return;
    if (!e.currentTarget.contains(e.relatedTarget)) {
        e.currentTarget.classList.remove('drag-over');
    }
}

function handleDrop(e) {
    if (isFrozen) return;
    
    e.preventDefault();
    e.currentTarget.classList.remove('drag-over');
    
    const studentId = e.dataTransfer.getData('text/plain');
    const desk = document.querySelector(`[data-student-id="${studentId}"]`);
    
    if (desk) {
        // Calculate position relative to classroom container
        const classroomRect = e.currentTarget.getBoundingClientRect();
        const x = e.clientX - classroomRect.left - 40; // Center the desk
        const y = e.clientY - classroomRect.top - 25;
        
        // Snap to 22px grid
        const snapSize = 22;
        const snappedX = Math.round(x / snapSize) * snapSize;
        const snappedY = Math.round(y / snapSize) * snapSize;
        
        // Ensure desk stays within bounds
        const maxX = classroomRect.width - 80;
        const maxY = classroomRect.height - 50;
        
        const finalX = Math.max(10, Math.min(snappedX, maxX));
        const finalY = Math.max(40, Math.min(snappedY, maxY - 80)); // Leave space for teacher desk
        
        // Move desk to classroom
        desk.classList.add('in-classroom');
        desk.style.position = 'absolute';
        desk.style.left = finalX + 'px';
        desk.style.top = finalY + 'px';
        desk.style.margin = '0';
        
        e.currentTarget.appendChild(desk);
    }
}

function saveClassroomLayout() {
    const desksInClassroom = document.querySelectorAll('#classroom-container .student-desk');
    const layout = {};
    
    desksInClassroom.forEach(desk => {
        layout[desk.dataset.studentId] = {
            x: parseInt(desk.style.left),
            y: parseInt(desk.style.top),
            studentName: desk.textContent
        };
    });
    
    // Get selected class from global filter
    const globalClassFilter = document.getElementById('global_class_filter');
    const className = globalClassFilter ? globalClassFilter.value : '';
    
    if (!className) {
        alert('Please select a class first');
        return;
    }
    
    // Find classroom ID
    fetch('/api/get_teacher_classrooms')
        .then(response => response.json())
        .then(data => {
            // First try exact match
            let classroom = data.classrooms.find(c => c.name === className);
            // If not found, try matching just the base name (before the grade part)
            if (!classroom) {
                classroom = data.classrooms.find(c => c.name.startsWith(className + ' ('));
            }
            if (classroom) {
                return fetch('/api/save_classroom_layout', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        classroom_id: classroom.id,
                        layout_data: layout
                    })
                });
            } else {
                throw new Error('Classroom not found');
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                classroomLayout = layout;
                isFrozen = true;
                
                // Update UI
                document.getElementById('classroom-container').classList.add('frozen');
                document.getElementById('saveBtn').style.display = 'none';
                document.getElementById('editBtn').style.display = 'inline-block';
                
                // Hide the pool since layout is saved
                document.getElementById('student-desks-section').style.display = 'none';
                document.getElementById('instructions').style.display = 'none';
                
                alert('{{ _("Classroom layout saved successfully!") }}');
            } else {
                alert('Error saving layout: ' + data.error);
            }
        })
        .catch(error => {
            alert('Error saving classroom layout');
        });
}

function editClassroomLayout() {
    isFrozen = false;
    
    // Update UI
    document.getElementById('classroom-container').classList.remove('frozen');
    document.getElementById('saveBtn').style.display = 'inline-block';
    document.getElementById('editBtn').style.display = 'none';
    
    // Show the pool and instructions again
    document.getElementById('student-desks-section').style.display = 'block';
    document.getElementById('instructions').style.display = 'block';
    
    // Keep desks in their current positions - don't move them back to pool
    // Teachers can now just adjust 1-2 desks without redoing the entire layout
}

function loadSavedLayoutForClass(className) {
    // Find classroom ID and load saved layout
    fetch('/api/get_teacher_classrooms')
        .then(response => response.json())
        .then(data => {
            // First try exact match
            let classroom = data.classrooms.find(c => c.name === className);
            // If not found, try matching just the base name (before the grade part)
            if (!classroom) {
                classroom = data.classrooms.find(c => c.name.startsWith(className + ' ('));
            }
            if (classroom) {
                return fetch(`/api/get_classroom_layout/${classroom.id}`);
            } else {
                throw new Error('Classroom not found');
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success && data.layout_data) {
                applyLayout(data.layout_data);
            } else {
                console.log('No saved layout found for this classroom');
            }
        })
        .catch(error => {
            console.error('Error loading saved layout:', error);
        });
}

function applyLayout(layoutData) {
    const pool = document.getElementById('student-desks-pool');
    const classroom = document.getElementById('classroom-container');
    
    // Move desks from pool to classroom based on saved positions
    Object.keys(layoutData).forEach(studentId => {
        const desk = document.querySelector(`[data-student-id="${studentId}"]`);
        const position = layoutData[studentId];
        
        if (desk && position) {
            // Move desk to classroom
            desk.classList.add('in-classroom');
            desk.style.position = 'absolute';
            desk.style.left = position.x + 'px';
            desk.style.top = position.y + 'px';
            desk.style.margin = '0';
            classroom.appendChild(desk);
        }
    });
    
    // If we have a saved layout, set to frozen state
    if (Object.keys(layoutData).length > 0) {
        classroomLayout = layoutData;
        isFrozen = true;
        
        // Update UI to frozen state
        document.getElementById('classroom-container').classList.add('frozen');
        document.getElementById('saveBtn').style.display = 'none';
        document.getElementById('editBtn').style.display = 'inline-block';
        document.getElementById('student-desks-section').style.display = 'none';
        document.getElementById('instructions').style.display = 'none';
    }
}
</script>
{% endblock %}
